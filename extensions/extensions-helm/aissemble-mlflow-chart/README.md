# aiSSEMBLE&trade; MLflow Helm Chart
Baseline Helm chart for packaging and deploying MLflow. Built on the [Bitnami Helm chart](https://bitnami.com/stack/mlflow/helm) and managed during the normal Maven build lifecycle and placed in the **target/helm/repo** directory. See [Helm Maven Plugin](https://github.com/kokuwaio/helm-maven-plugin) for more details.

# Basic usage with Helm CLI
To use the module, perform [extension-helm setup](../README.md#leveraging-extensions-helm) and override the chart version with the desired aiSSEMBLE version. For example:
```bash
helm install mlflow oci://ghcr.io/boozallen/aissemble-mlflow-chart --version <AISSEMBLE-VERSION>
```
**Note**: *the version should match the aiSSEMBLE project version.*

# Properties
The following properties are inherited from the base [MLflow chart](https://github.com/bitnami/charts/blob/main/bitnami/mlflow/README.md), but with updated default values. 

| Property                    | Description                                                 | Default       |
|-----------------------------|-------------------------------------------------------------|---------------|
| image.tag                   | MLflow image version tag                                    | Chart.Version |
| postgresql.enabled          | Switch to enable or disable Bitnami's PostgreSQL helm chart | False         |
| minio.enabled               | Switch to enable or disable MinIO helm chart                | False         |
| run.enabled                 | Switch to enable or disable Run helm chart                  | False         |
| tracking.auth.enabled       | Switch to enable or disable basic authentication            | False         |
| tracking.service.ports.http | MLflow service HTTP port                                    | 5005          |
| tracking.service.type       | MLflow service type                                         | ClusterIP     |
| externalDatabase.host       | Database host                                               | postgres      |
| externalDatabase.port       | Database port number                                        | 5432          |
| externalDatabase.user       | Non-root username                                           | postgres      |
| externalDatabase.password   | Password for the non-root username                          | password      |
| externalDatabase.database   | Database name                                               | db            |

All properties must be prefixed with the key `aissemble-mlflow-chart.mlflow` to override any values in the chart. See [helm documentation](https://helm.sh/docs/chart_template_guide/subcharts_and_globals/#overriding-values-from-a-parent-chart) for more info.

# Migration from aiSSEMBLE v1 Helm Charts
If you are migrating from the v1 version of the MLflow chart, use the tables below to apply any existing customizations from the old chart to the new v2 chart. The v1 version of the MLflow charts corresponds to Bitnami's Tracking charts and as a result, most of the property changes applies to the `tracking` parameter. As part of the migration, the Helm Charts should utilize the aiSSEMBLE `aissemble-mlflow` Docker image rather than the Docker image generated by the project. 

| Old Property Location                   | New Property Location                                | Same Default Value | Additional Notes                                                                                                                                                                                                                                                                                                            |
|-----------------------------------------|------------------------------------------------------|--------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| deployment.args                         | tracking.extraArgs                                   | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.automountServiceAccountToken | tracking.serviceAccount.automountServiceAccountToken | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.command                      | tracking.command                                     | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.env                          | tracking.extraEnvVars                                | No                 | Environment variables related to S3 and AWS should be set within the `externalS3` parameter and Postgres configuration should be set within the `externalDatabase` parameter. `GIT_PYTHON_REFRESH` and `PYTHONUNBUFFERED` are set within the baseline Docker image and no longer needs to be configured on the Helm charts. |
| deployment.hostname                     | tracking.ingress.hostname                            | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.initContainers               | tracking.initContainers                              | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.nodeSelector                 | tracking.nodeSelector                                | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.ports                        | tracking.containerPorts.http                         | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.resources                    | tracking.resources.requests                          | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.securityContext              | tracking.containerSecurityContext                    | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.serviceAccountName           | tracking.serviceAccount.name                         | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.volumeMounts                 | tracking.extraVolumeMounts                           | Yes                |                                                                                                                                                                                                                                                                                                                             |
| deployment.volumes                      | tracking.extraVolumes                                | Yes                |                                                                                                                                                                                                                                                                                                                             |
| image.name                              | image.registry                                       | No                 | V2 Helm Chart needs to use the `aissemble-mlflow` image                                                                                                                                                                                                                                                                     |
| image.imagePullPolicy                   | image.pullPolicy                                     | Yes                |                                                                                                                                                                                                                                                                                                                             |
| image.dockerRepo                        | image.repository                                     | Yes                |                                                                                                                                                                                                                                                                                                                             |
| ingress.enabled                         | tracking.ingress.enabled                             | Yes                | By default, ingress is disabled                                                                                                                                                                                                                                                                                             |
| ingress.hosts[\*].host                  | tracking.ingress.hostname                            | Yes                |                                                                                                                                                                                                                                                                                                                             |
| ingress.hosts[\*].paths[\*].path        | tracking.ingress.path                                | Yes                |                                                                                                                                                                                                                                                                                                                             |
| ingress.hosts[\*].paths[\*].pathType    | tracking.ingress.pathType                            | Yes                |                                                                                                                                                                                                                                                                                                                             |
| ingress.hosts                           | tracking.ingress.extraHosts                          | No                 |                                                                                                                                                                                                                                                                                                                             |
| ingress.metadata.annotations            | tracking.ingress.annotations                         | Yes                | By default, the key `kubernetes.io/ingress.class` is set to `nginx`                                                                                                                                                                                                                                                         |
| service.spec.ports[\*].port             | tracking.service.ports.http                          | Yes                |                                                                                                                                                                                                                                                                                                                             |
| service.spec.type                       | tracking.service.type                                | Yes                |                                                                                                                                                                                                                                                                                                                             |

As part of the migration, you will also need to change the host value to `http://mlflow-ui-tracking` for the `mlflow_tracking_uri` key in the `<YOUR-PROJECT>-pipelines/<YOUR-PIPELINE>/<YOUR-STEP>/src/<YOUR_STEP>/resources/krausening/base/pipeline.properties` file.

# Property Removed
The following properties no longer exist.

| Property                          | Reason                                     |
|-----------------------------------|--------------------------------------------|
| deployment.restartPolicy          | The property is not used in the new chart  |
| ingress.status                    | This property is not used in the new chart |
| service.spec.ports[\*].name       | This property is not used in the new chart |
| service.spec.ports[\*].targetPort | This property is not used in the new chart |
