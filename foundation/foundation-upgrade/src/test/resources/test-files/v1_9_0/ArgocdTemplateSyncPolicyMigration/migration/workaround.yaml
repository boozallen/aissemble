apiVersion: argoproj.io/v1alpha1
kind: Application
spec:
    destination:
        namespace: vp-argocd
        server: {{ .Values.spec.destination.server }}
    project: default
    source:
        path: vp-deploy/src/main/resources/apps/spark-operator
        repoURL: {{ .Values.spec.repo }}
        targetRevision: {{ .Values.spec.targetRevision }}
        {{ if .Values.spec.helm.valueFiles }}
        helm:
            valueFiles:
                {{- range .Values.spec.helm.valueFiles }}
                - {{ . }}
                {{- end }}
        {{ end }}
    syncPolicy:
        {{/* This template comment explains how the logic below works*/}}
        {{- /* This one trims the newlines so it doesn't affect output */ -}}

        #these options are important
        syncOptions:
        - CreateNamespace=true # this make deployment in a new env easier
        - ServerSideApply=true # https://github.com/argoproj/argo-cd/issues/820#issuecomment-135463693
metadata:
    name: vp-spark-operator
    namespace: argocd
    finalizers:
        - resources-finalizer.argocd.argoproj.io
